# Фаза 1 — Ядро генерации (3–5 дней)

Цель: подготовить расширяемое ядро генерации, которое умеет синтезировать связанные сущности для людей, финансов, e-commerce и логов. Фаза считается завершенной, когда все описанные модули работают изолированно и в составе пайплайна массовой генерации (1–100k+ записей).

---

## 1. Архитектурные принципы

1. **Модульность**: каждый набор данных оформлен как самостоятельный модуль `GeneratorModule<T>` с единым интерфейсом (`generate(params)`, `validate(entity)`, `seed(dictionaries)`).
2. **Комбинаторность**: составные сущности собираются в `ScenarioPipeline`, который связывает людей, финансы, e-commerce и логи с учётом зависимостей (человек → платежные инструменты → заказы → логи).
3. **Масштабируемость**: генерация батчами (chunk size конфигурируемый, по умолчанию 1000) + streaming writer (JSONL / CSV / Kafka stub) для 100k+.
4. **Детерминированность по seed**: любой генератор принимает `RandomSource` с фиксированным seed для воспроизводимости.
5. **Валидация**: каждая сущность проходит модульную проверку (формат, контрольные суммы, диапазоны). Ошибки агрегируются и логируются.

---

## 2. Обзор модулей

| Модуль | Ответственность | Ключевые зависимости |
| --- | --- | --- |
| `person` | ФИО, пол, дата рождения, возраст, адрес, контакты, удостоверения (паспорт, СНИЛС, ИНН) | `names.json`, `regions.json`, `cities.json`, `streets.json`, `division_codes.json`, алгоритмы INN/SNILS |
| `finance` | Банковские карты, транзакции, чеки | `person`, псевдо-BIN таблица, справочник категорий MCC |
| `ecommerce` | Товары, категории, заказы, статусы | `finance` (платёж), `person` (покупатель), список SKU |
| `logs` | HTTP, syslog, trace событий пользователя | `ecommerce` (действия), `person` (аккаунт), справочник эндпоинтов |

---

## 3. Детализация модулей

### 3.1 PersonModule

- **ФИО**: взвешенный выбор по полу, отчества по алгоритму из `GENERATION_ALGORITHMS.md`.
- **Дата рождения и возраст**: нормальное распределение, сохранение ISO date + age integer.
- **Адрес**: вложенные справочники (страна → регион → город → улица). Поддержка опциональных квартиры/индекса.
- **Контакты**:
  - Телефон: форматы `+7` и e.164, маскирование 8/9/10/11 цифр.
  - Email: шаблоны `<f>.<l>@domain`, списки доменов + случайные.
- **Паспорт**: серия/номер, код подразделения, дата выдачи (валидная относительно возраста).
- **СНИЛС / ИНН**: строгие контрольные суммы.

Выход: `PersonProfile` (typed interface) + utility `toProfileDTO`.

### 3.2 FinanceModule

- **Карты**:
  - BIN-таблица (4–6 цифр) в `data-dictionaries/cards.json`.
  - Номера через алгоритм Луна, генерируем срок (48–60 месяцев), CVV (000–999).
- **Транзакции**:
  - Типы: `debit`, `credit`.
  - Атрибуты: сумма, валюта (по умолчанию RUB, поддержка USD/EUR), MCC, описание.
  - Сценарии: зарплата → расходы, случайные переводы.
- **Чеки**:
  - Форматы покупок и возвратов, список позиций, НДС, метод оплаты (привязка к карте).

Выход: `FinanceProfile` + ссылки на `PersonProfile`.

### 3.3 EcommerceModule

- **Товары**: справочник SKU (название, категория, базовая цена). Возможность генерации on-the-fly.
- **Заказы**:
  - Структура: `Order { person_id, items[], payment_method, total, status }`.
  - Статусы: `paid`, `cancelled`, `refunded` с вероятностями и переходами.
  - Связка с транзакциями (transaction_id).
- **Валидация**:
  - Сумма заказа = сумма позиций ± скидки.
  - Согласованность статуса и платежа (например, `refunded` → транзакция с отрицательной суммой).

### 3.4 LogsModule

- **HTTP**: генерация URIs, методов, latency, кодов (2xx/4xx/5xx распределение).
- **Syslog/App**: уровни `INFO/WARN/ERROR`, сообщения шаблонов.
- **User Trace**: последовательность действий (просмотр товара → добавление → оплата → возврат). Привязка к `person_id` и `order_id`.

Выход: `LogBundle` с `http`, `syslog`, `user_trace`.

---

## 4. Пайплайн генерации

1. **Инициализация**:
   - Загрузка справочников в `DictionaryRegistry`.
   - Конфигурация seed, размеров батча, доли отмен/возвратов, валют.
2. **Генерация батча**:
   - `PersonModule.generateBatch(n)` → список людей.
   - `FinanceModule.enrich(people)` → карты + транзакции.
   - `EcommerceModule.buildOrders(people, cards)` → заказы, чеки.
   - `LogsModule.emit(events)` → логи на основе заказов.
3. **Экспорт**:
   - `BatchWriter` (JSONL, CSV, stream callback). Поддержка chunked flush и backpressure.
4. **Метрики**:
   - Счётчики генерации (успех/ошибки), тайминги, объём данных.

---

## 5. План работ (3–5 дней)

| День | Фокус | Результат |
| --- | --- | --- |
| 1 | Аудит справочников, каркас `GeneratorModule`, `RandomSource`, `DictionaryRegistry` | Базовая инфраструктура, unit-тесты утилит |
| 2 | `PersonModule` (ФИО, дата, адрес, паспорт, СНИЛС, ИНН, контакты) | Покрытые тестами генераторы, типы DTO |
| 3 | `FinanceModule` (карты, транзакции, чеки) | Генерация карт + транзакций, связь с Person |
| 4 | `EcommerceModule` (товары, заказы, статусы, связь с Finance) | Рабочие заказы, проверки согласованности, тесты |
| 5 | `LogsModule`, батчевый пайплайн, нагрузочное тестирование до 100k, документация | Профили производительности, CLI/HTTP endpoint |

Буферы (0.5 дня): рефакторинг, доработка тестов, улучшение UX CLI.

---

## День 1 — статус

- Собран модуль `backend/src/generation` с едиными интерфейсами, `RandomSource` и `DictionaryRegistry`.
- Добавлены unit-тесты для новых утилит (`npm run test -- generation`), зафиксировано прохождение.
- Документированы принципы повторного использования словарей и детерминированных генераторов; следующие шаги — реализация `PersonModule`.

---

## День 2 — статус

- Реализован `PersonModule` на новом каркасе: ФИО, дата рождения, адрес, телефон, email, паспорт, ИНН, СНИЛС.
- Добавлены типы и юнит-тесты `person.module.spec.ts`, покрывающие параметры пола/региона и отключение документов.
- Обновлён `DictionaryRegistry` (правильный путь к справочникам) и экспорт новых модулей через `src/generation/index.ts`.

---

## День 3 — статус

- Добавлены справочники `card_bins.json` и `mcc_codes.json`, описывающие BIN, банки-эмитенты и категории торговцев.
- Реализован `FinanceModule`, который генерирует карты (валидный Лун, expiry, CVV), транзакции (списания/поступления) и чеки с товарами.
- Созданы новые типы (`PaymentCard`, `CardTransaction`, `Receipt`, `FinanceProfile`) и тесты `finance.module.spec.ts`; покрытие — `npm run test -- generation`.

---

## 6. Тестирование и валидация

- **Unit**: каждый генератор покрывается тестами на формат, контрольные суммы, диапазоны.
- **Property-based**: для карт/ИНН/СНИЛС (1000 итераций) проверяем, что результат проходит валидатор.
- **E2E**: тест сценария `generateBatch(100)` → проверка связей между сущностями.
- **Нагрузочные**: CLI `generate --count 100000 --format jsonl` с измерением времени и памяти.

---

## 7. Артефакты и документация

1. Обновлённый `docs/GENERATION_ALGORITHMS.md` (ссылки на новые модули).
2. Swagger/AsyncAPI описания новых DTO (в `docs/BACKEND_SPEC.md` после реализации API).
3. Тестовые отчёты (`backend/coverage/*`) с новым покрытием.
4. Примеры датасетов (10, 1000, 100000 записей) для QA.

---

## 8. Риски и меры

- **Объём справочников**: кеширование, lazy load.
- **Контрольные суммы**: проверка против существующих валидаторов, cross-tests.
- **Производительность**: профилирование hot-path, использование `worker_threads` для больших объёмов (за рамками 1 фазы).
- **Согласованность данных**: контрактные тесты между модулями (например, каждый заказ ссылается на существующий `person_id` и `card_id`).

---

Этот документ служит рабочим ориентиром Фазы 1. После завершения необходимо провести демо, собрать метрики и зафиксировать ретро для перехода к расширенному API/экспорту.

